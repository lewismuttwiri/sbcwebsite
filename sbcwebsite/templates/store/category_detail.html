{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <a href="{% url 'store:category_list' %}" class="text-blue-500 hover:underline">
            &larr; Back to Categories
        </a>
    </div>
    
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">{{ category.name }}</h1>
        {% if category.description %}
        <p class="text-gray-700">{{ category.description }}</p>
        {% endif %}
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for product in products %}
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <img class="w-full h-48 object-cover" src="{{ product.image.url }}" alt="{{ product.name }}">
            <div class="p-4">
                <h2 class="text-xl font-bold mb-2">{{ product.name }}</h2>
                <p class="text-gray-700 text-sm mb-4">{{ product.description|truncatewords:20 }}</p>
                <div class="flex justify-between items-center">
                    <span class="text-gray-900 font-bold">KES {{ product.price }}</span>
                    <button class="add-to-cart-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" 
                            data-product-id="{{ product.id }}">
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-3 text-center py-8">
            <p class="text-gray-500">No products available in this category yet.</p>
        </div>
        {% endfor %}
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
        
        addToCartButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                
                fetch(`/store/add-to-cart/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        quantity: 1
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Update cart count in header
                    const cartCountElement = document.getElementById('cart-count');
                    if (cartCountElement) {
                        cartCountElement.textContent = data.count;
                    }
                    
                    // Show success message
                    alert('Product added to cart!');
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
{% endblock %}
